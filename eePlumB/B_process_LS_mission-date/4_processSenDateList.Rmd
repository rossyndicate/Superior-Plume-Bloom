---
title: "Process GEE Sentinel-Date File"
author: "B Steele"
date: "2023-06-26"
output: html_document
---

```{r}
library(tidyverse)
library(googledrive)

# authorize google drive
drive_auth()

```

# Purpose

This script processes the file created in GEE using the script `1_createMissionDateList.js` to create a list of unique mission-date pairs for eePlumB users.

## Download and load raw mission-date list

```{r}
temp_dir = 'tmp'
dir.create('tmp')

sup_drive = drive_ls(pattern = 'Bloom Project', recursive = F)
folder = drive_ls(pattern = 'eePlumB_output', path = as_id(sup_drive))
file = drive_ls(path = as_id(folder$id), pattern = 'sen2_date_list.csv', recursive = T)

drive_download(as_id(file$id), path = file.path(temp_dir, file$name))

miss_date = read.csv(file.path(temp_dir, file$name))
```

## Summarize mission-date list

The mission-date list includes multiple scenes per mission-date pair, so we want to summarize by mission and date.

```{r}
miss_date_unique = miss_date %>% 
  group_by(date) %>%
  summarise(n_tiles = n(),
            tiles = paste0(MGRS_TILE, collapse = '; '))
```

Filter for April through November.

```{r}
miss_date_filt = miss_date_unique %>% 
  mutate(date = as.Date(date),
         month = as.numeric(format(date, '%m'))) %>% 
  filter(month >=4, month <= 11)
```

Sort the list randomly

```{r}
random_mission_date = miss_date_filt[sample(1:nrow(miss_date_filt)),]
```

And format for the users.

```{r}
random_mission_date = random_mission_date %>% 
  mutate(mission = 'SEN2') %>% 
  select(mission,
         date,
         n_tiles,
         tiles) %>% 
  mutate(name = '', initials = '', `finished?` = '') %>% 
  relocate(mission, date, name, initials, `finished?`)

```

## Save file to Drive

```{r}
write.csv(random_mission_date, file.path(temp_dir, 'random_sentinel_date.csv'), row.names = F)

drive_upload(file.path(temp_dir,'random_sentinel_date.csv'), path = as_id(folder$id), name = 'eePlumB Sentinel-Date List', type = 'spreadsheet', overwrite = F)
```

## Clean up tmp dir

```{r}
unlink('tmp', recursive = T)
```
