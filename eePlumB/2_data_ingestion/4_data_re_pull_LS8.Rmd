---
title: "Re-pull the LS8 band data using the volunteer points"
author: "ROSSyndicate"
date: "2024-03-04"
output: html_document
---

# Purpose

This script uses the volunteer point locations exported from
`1_data_download.Rmd` which have been manually uploaded as a feature collection
to the `ee-ross-superior` project in Earth Engine.

## R/Python Setup

Load (and install, if needed) the necessary packages for this script.

```{r load-r-pkgs}
libs <- c("reticulate", "tidyverse")

package_loader <- function(x) {
    if (x %in% installed.packages()) {
      library(x, character.only = TRUE)
    } else {
      install.packages(x)
      library(x, character.only = TRUE)
    }
}

invisible(lapply(libs, package_loader))
```

Use the conda environment if the env folder is present, otherwise create the
environment.

```{r conda-env}
if (!dir.exists("env")) {
  source("pySetup.R")
} else {
  use_condaenv(file.path(getwd(), "env"))
}
```

Load python modules and authenticate/initialize EE.

```{python}
import ee
import imp
imp.load_source("re_pull", "eePlumB/2_data_ingestion/re_pull_functions.py")
import re_pull as rp

ee.Authenticate()
ee.Initialize(project = "ee-ross-superior")
```

## Sort labels

Here, we'll load the entire label list, then filter for only the LS8 labels

```{python}
labels = ee.FeatureCollection("projects/ee-ross-superior/assets/labels/collated_label_data_v2023-07-20")

labels_8 = labels.filter(ee.Filter.eq("mission", "LS8"))
```

Get the unique dates of images from this list and assign the date to the
`system:time_start` parameter.

```{python}
dates_8 = labels_8.aggregate_array("date").distinct()

labels_8_dt = labels_8.map(rp.set_date)
```

## Get feature collection ready

Filter the Landsat 8 stack, then export the scene metadata

```{python}
# filter stack for desired PRs
ROWS = ee.List([27, 28])

# ls8 stack, filtered and with all functions applied
l8 = (ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
  .filter(ee.Filter.eq('WRS_PATH', 26))
  .filter(ee.Filter.inList('WRS_ROW', ROWS))
  .filter(ee.Filter.gte('IMAGE_QUALITY_OLI', 7)))

export_l8_meta = (ee.batch.Export.table.toDrive(
  collection = l8,
  description = 'LS8_image_metadata',
  folder = 'EE_output',
  fileNamePrefix = 'LS8_image_metadata',
  fileFormat = 'csv'))
  
# export_l8_meta.start()

```

And then apply the scaling factors to the stack

And then apply the scaling factors to the stack

```{python}
l8 = (l8
  .map(rp.applyScaleFactors_89)
  .map(rp.apply_radsat_mask)
  .map(rp.flag_qa_conf)
  .map(rp.flag_high_aerosol)
  .map(rp.addImageDate))

```

## Export location information by dates

```{python}
# loop and export additional data
for i in range(dates_8.length().getInfo()):
  one_date = dates_8.get(i)
  print(one_date.getInfo())
  one_dt = ee.Date(one_date)
  dt_label = labels_8_dt.filterDate(one_dt, one_dt.advance(1, 'day'))
  one_image_SR_band = (l8
    .filterDate(one_dt, one_dt.advance(1, 'day'))
    .select(['SR_B1', 'SR_B2', 'SR_B3', 'SR_B4', 'SR_B5', 'SR_B6', 'SR_B7'])
    .mean())
  one_image_bits = (l8
    .filterDate(one_dt, one_dt.advance(1, 'day'))
    .select(['cirrus_conf', 'snowice_conf', 'cloudshad_conf',
                          'cloud_conf', 'dialated_cloud', 'aero_level'])
    .max())
  one_image_cdist = (l8
    .filterDate(one_dt, one_dt.advance(1, 'day'))
    .select('ST_CDIST')
    .min())
                        
  
  #define bands to extract and reduce regions
  bandsOut = one_image_SR_band.addBands(one_image_bits).addBands(one_image_cdist)

  combinedReducer = (ee.Reducer.median().unweighted()
                      .forEachBand(bandsOut.select(['SR_B1', 'SR_B2', 'SR_B3',
                      'SR_B4', 'SR_B5', 'SR_B6', 'SR_B7']))
    .combine(ee.Reducer.max().unweighted()
      .forEachBand(bandsOut.select(['cirrus_conf', 'snowice_conf', 'cloudshad_conf',
                          'cloud_conf', 'dialated_cloud', 'aero_level'])), sharedInputs = False)
    .combine(ee.Reducer.min().unweighted()
      .forEachBand(bandsOut.select('ST_CDIST')), sharedInputs = False)
    )
  # Collect median reflectance and occurance values
  # Make a cloud score, and get the water pixel count
  data = (bandsOut
    .reduceRegions(
      collection = dt_label,
      reducer = combinedReducer,
      scale = 30,
      crs = one_image_SR_band.geometry().projection().crs()))
      
  image_date_export = (ee.batch.Export.table.toDrive(
    collection = data,
    description = 'LS8_' + one_date.getInfo(),
    folder = 'eePlumB_additional_band_data',
    fileNamePrefix = 'LS8_' + one_date.getInfo() + '_additional_vars_v2024-04-25',
    fileFormat = 'csv'))
    
  image_date_export.start()

```
