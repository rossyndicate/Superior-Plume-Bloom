---
title: "Re-pull the LS5 band data using the volunteer points"
author: "ROSSyndicate"
date: "2024-03-04"
output: html_document
---

# Purpose

This script uses the volunteer point locations exported from `1_data_download.Rmd` which have been manually uploaded as a feature collection to the `ee-ross-superior` project in Earth Engine.

## R/Python Setup

Load (and install, if needed) the necessary packages for this script.

```{r load-r-pkgs}
libs <- c("reticulate", "tidyverse")

package_loader <- function(x) {
    if (x %in% installed.packages()) {
      library(x, character.only = TRUE)
    } else {
      install.packages(x)
      library(x, character.only = TRUE)
    }
}

invisible(lapply(libs, package_loader))
```

Use the conda environment if the env folder is present, otherwise create the environment.

```{r conda-env}
if (!dir.exists("env")) {
  source("pySetup.R")
} else {
  use_condaenv(file.path(getwd(), "env"))
}
```

Load python modules and authenticate/initialize EE.

```{python}
import ee

ee.Authenticate()
ee.Initialize(project = "ee-ross-superior")
```

## Sort labels

Here, we'll load the entire label list, then filter for only the LS5 labels

```{python}
labels = ee.FeatureCollection("projects/ee-ross-superior/assets/labels/collated_label_data_v2023-07-20")

labels_5 = labels.filter(ee.Filter.eq("mission", "LS5"))
```

Get the unique dates of images from this list and assign the date to the `system:time_start` parameter.

```{python}
dates_5 = labels_5.aggregate_array("date").distinct()

# add date as property to filter by
def set_date(feature):
  date = feature.get('date')
  return feature.set({'system:time_start': ee.Date(date)})


labels_5_dt = labels_5.map(set_date)
```

## Get feature collection ready

Filter the Landsat 5 stack, then export the metadata of the task

```{python}
# filter stack for desired PRs
ROWS = ee.List([27, 28])

# ls7 stack, filtered and with all functions applied
l5 = (ee.ImageCollection('LANDSAT/LT05/C02/T1_L2')
  .filter(ee.Filter.eq('WRS_PATH', 26))
  .filter(ee.Filter.inList('WRS_ROW', ROWS))
  .filter(ee.Filter.gte('IMAGE_QUALITY', 7)))

export_l5_meta = (ee.batch.Export.table.toDrive(
  collection = l5,
  description = 'LS5_image_metadata',
  folder = 'eePlumB_output',
  fileNamePrefix = 'LS5_image_metadata',
  fileFormat = 'csv'))
  
export_l5_meta.start()

```

And then apply the scaling factors to the stack

```{python}
# function to apply scaling factors
def applyScaleFactors(image):
  opticalBands = image.select("SR_B.").multiply(0.0000275).add(-0.2)
  thermalBands = image.select("ST_B.").multiply(0.00341802).add(149.0)
  opac = image.select('SR_ATMOS_OPACITY').multiply(0.0001)
  return (image
    .addBands(opticalBands, None, True)
    .addBands(thermalBands, None, True)
    .addBands(opac, None, True))


# function to mask saturated pixels
def apply_radsat_mask(image):
  radsat = image.select('QA_RADSAT').eq(0)
  return image.updateMask(radsat)


# function to add image date
def addImageDate(image):
  mission = image.get('SPACECRAFT_ID')
  date = image.date().format('YYYY-MM-dd')
  missDate = ee.String(mission).cat('_').cat(ee.String(date))
  return image.set('missDate', missDate)


l5 = (l5
  .map(applyScaleFactors)
  .map(apply_radsat_mask)
  .map(addImageDate))

```

## Export location information by dates

```{python}
# loop and export additional data
for i in range(dates_5.length().getInfo()):
  one_date = dates_5.get(i)
  print(one_date.getInfo())
  one_dt = ee.Date(one_date)
  dt_label = labels_5_dt.filterDate(one_dt, one_dt.advance(1, 'day'))
  one_image = l5.filterDate(one_dt, one_dt.advance(1, 'day')).mean()
  
  #define bands to extract and reduce regions
  data = (one_image
    .reduceRegions(
      collection = dt_label,
      reducer = ee.Reducer.median().forEachBand(one_image),
      scale = 30,
      tileScale = 2,
      crs = one_image.geometry().projection().crs()
      ))
  
  image_date_export = (ee.batch.Export.table.toDrive(
    collection = data,
    description = 'LS5_' + one_date.getInfo(),
    folder = 'eePlumB_additional_band_data',
    fileNamePrefix = 'LS5_' + one_date.getInfo() + '_additional_vars',
    fileFormat = 'csv'))
    
  image_date_export.start()

```
